<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Scanner</title>
    <script src="https://unpkg.com/@zxing/browser@latest"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
</head>
<body class="has-background-light">
    <div class="container is-flex is-flex-direction-column is-align-items-center is-justify-content-space-between" style="height: 100vh; padding: 10px;">
        
        <!-- Camera Preview & Scanned Image -->
        <div class="columns is-gapless is-mobile" style="width: 100%;">
            <div class="column is-half">
                <div class="box is-flex is-justify-content-center is-align-items-center" style="aspect-ratio: 1 / 1; overflow: hidden;">
                    <video id="video" autoplay playsinline class="is-fullwidth" style="object-fit: cover; width: 100%; height: 100%;"></video>
                </div>
            </div>
            <div class="column is-half">
                <div class="box is-flex is-justify-content-center is-align-items-center" style="aspect-ratio: 1 / 1;">
                    <canvas id="canvas"></canvas>
                </div>
            </div>
        </div>

        <!-- Scanned Result -->
        <div id="scanResult" class="box is-flex is-justify-content-center is-align-items-center has-text-centered is-size-5 has-text-weight-bold" style="flex-grow: 1; width: 100%;">
            RESULT
        </div>

        <!-- Thumbnail History -->
        <div id="historyContainer" class="is-flex" style="width: 100%; gap: 5px; overflow-x: auto;">
            <!-- Thumbnails will be added here -->
        </div>

        <!-- Scan Button -->
        <button id="scanButton" class="button is-primary is-fullwidth" style="height: 64px;">
            SCAN
        </button>
    </div>

    <script>
        const video = document.getElementById('video');
        const scanButton = document.getElementById('scanButton');
        const scanResult = document.getElementById('scanResult');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const historyContainer = document.getElementById('historyContainer');

        async function requestCameraPermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
            } catch (error) {
                alert("Camera permission is required.");
            }
        }

        async function scanImage() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            const scanner = new ZXing.BrowserQRCodeReader();
            try {
                const result = await scanner.decodeFromCanvas(canvas);
                scanResult.textContent = result.text;
                addToHistory();
            } catch {
                scanResult.textContent = "No QR code detected";
            }
        }

        function addToHistory() {
            const img = document.createElement("img");
            img.src = canvas.toDataURL("image/png");
            img.style.width = "64px";
            img.style.height = "64px";
            img.style.objectFit = "cover";
            img.classList.add("box");

            historyContainer.prepend(img);
            if (historyContainer.children.length > 3) {
                historyContainer.removeChild(historyContainer.lastChild);
            }
        }

        scanButton.addEventListener("click", scanImage);
        document.addEventListener("DOMContentLoaded", requestCameraPermission);
    </script>
</body>
</html>
